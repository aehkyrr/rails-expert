# Kamal Configuration Examples
#
# Complete examples of Kamal deployment configurations for various scenarios

# ==============================================================================
# BASIC CONFIGURATION
# ==============================================================================

# .kamal/deploy.yml
service: myapp
image: username/myapp

servers:
  web:
    hosts:
      - 192.168.1.100

registry:
  username: dockerhub-username
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  secret:
    - RAILS_MASTER_KEY

# ==============================================================================
# MULTI-SERVER CONFIGURATION
# ==============================================================================

service: myapp-production
image: company/myapp

servers:
  web:
    hosts:
      - 192.168.1.100
      - 192.168.1.101
      - 192.168.1.102
    labels:
      traefik.http.routers.myapp.rule: Host(`myapp.com`)
      traefik.http.routers.myapp.tls: true

  worker:
    hosts:
      - 192.168.1.200
    cmd: bundle exec solid_queue:start

registry:
  server: ghcr.io
  username: github-username
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_LEVEL: info
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL

# ==============================================================================
# WITH ACCESSORIES (Database, Redis)
# ==============================================================================

service: myapp
image: username/myapp

servers:
  web:
    hosts:
      - 192.168.1.100

accessories:
  db:
    image: postgres:16
    host: 192.168.1.100
    port: 5432
    env:
      POSTGRES_DB: myapp_production
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD:
        - DB_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
    options:
      health:
        interval: 10s
        timeout: 5s
        retries: 5

  redis:
    image: redis:7-alpine
    host: 192.168.1.100
    port: 6379
    directories:
      - data:/data

env:
  clear:
    DATABASE_URL: postgresql://myapp:password@db:5432/myapp_production
    REDIS_URL: redis://redis:6379/0
  secret:
    - RAILS_MASTER_KEY

# ==============================================================================
# STAGING + PRODUCTION ENVIRONMENTS
# ==============================================================================

# .kamal/deploy.yml (production)
service: myapp
image: company/myapp

servers:
  web:
    hosts:
      - prod-1.myapp.com
      - prod-2.myapp.com
    labels:
      traefik.http.routers.myapp.rule: Host(`myapp.com`)

env:
  clear:
    RAILS_ENV: production
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL

# .kamal/deploy.staging.yml (staging overrides)
servers:
  web:
    hosts:
      - staging.myapp.com
    labels:
      traefik.http.routers.myapp.rule: Host(`staging.myapp.com`)

env:
  clear:
    RAILS_ENV: staging
  secret:
    - RAILS_MASTER_KEY_STAGING
    - DATABASE_URL_STAGING

# Deploy to staging: kamal deploy -d staging
# Deploy to production: kamal deploy

# ==============================================================================
# CUSTOM HEALTH CHECK
# ==============================================================================

service: myapp
image: username/myapp

servers:
  web:
    hosts:
      - 192.168.1.100

healthcheck:
  path: /health  # Custom health endpoint
  port: 3000
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 30s  # Grace period after container start

# Rails health controller:
# class HealthController < ApplicationController
#   def show
#     checks = {
#       database: check_database,
#       cache: check_cache,
#       disk: check_disk_space
#     }
#
#     if checks.values.all?
#       render json: { status: "healthy", checks: checks }, status: :ok
#     else
#       render json: { status: "unhealthy", checks: checks }, status: :service_unavailable
#     end
#   end
# end

# ==============================================================================
# ASSET CDN CONFIGURATION
# ==============================================================================

service: myapp
image: username/myapp

env:
  clear:
    RAILS_ENV: production
    ASSET_HOST: https://cdn.myapp.com
    RAILS_SERVE_STATIC_FILES: "true"  # For Thruster to serve assets
  secret:
    - RAILS_MASTER_KEY

# Configure CDN to pull from your app:
# CloudFront, Fastly, CloudFlare, etc.
# Point to your app's /assets/* path

# ==============================================================================
# CUSTOM BUILD ARGS
# ==============================================================================

builder:
  args:
    RUBY_VERSION: 3.2.2
    BUNDLER_VERSION: 2.5.0
    NODE_VERSION: 20.0.0  # If needed for build
  cache:
    clear: false  # Keep build cache
  multiarch: false  # Single architecture (faster builds)

# ==============================================================================
# VOLUME MOUNTS FOR UPLOADS
# ==============================================================================

servers:
  web:
    hosts:
      - 192.168.1.100

volumes:
  - storage:/rails/storage  # Active Storage files

# Or use S3/cloud storage:
env:
  clear:
    ACTIVE_STORAGE_SERVICE: amazon
  secret:
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - AWS_BUCKET

# ==============================================================================
# ADVANCED: MULTIPLE SERVICES
# ==============================================================================

service: myapp
image: company/myapp

servers:
  web:
    hosts:
      - 192.168.1.100
      - 192.168.1.101
    options:
      cpus: "2"
      memory: "2g"

  worker:
    hosts:
      - 192.168.1.200
    cmd: bundle exec solid_queue:start
    options:
      cpus: "1"
      memory: "1g"

  scheduler:
    hosts:
      - 192.168.1.200
    cmd: bundle exec whenever
    options:
      cpus: "0.5"
      memory: "512m"

# ==============================================================================
# HOOKS FOR CUSTOM DEPLOYMENT STEPS
# ==============================================================================

# .kamal/hooks/pre-deploy
#!/bin/bash
# Runs before deploy

echo "Running database backup..."
# Backup database

echo "Notifying team..."
# Send Slack notification

# .kamal/hooks/post-deploy
#!/bin/bash
# Runs after successful deploy

echo "Clearing CDN cache..."
# Purge CDN cache

echo "Deployment complete!"
# Send success notification

# Make hooks executable:
# chmod +x .kamal/hooks/*

# ==============================================================================
# KEY CONFIGURATION OPTIONS
# ==============================================================================

# service: Unique name for your application
# image: Docker image name (registry/name format)
# servers: Server groups and their hosts
# registry: Docker registry configuration
# env: Environment variables (clear vs secret)
# accessories: Additional services (databases, caches)
# volumes: Persistent storage mounts
# healthcheck: Application health verification
# builder: Docker build configuration
# proxy: Kamal Proxy settings
# retention: How many old images/containers to keep

# Deploy with: kamal deploy
# Rollback with: kamal rollback
# SSH with: kamal app exec -i bash
